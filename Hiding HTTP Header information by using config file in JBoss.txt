
# Note:  
# 1. The user running the script must have administrative privileges.
# 2. The log file for the script will be generated as 'C:\HTTP_Header\HTTP_Header198_Log.log'.
# 3. Backup file will be generated at the same location of the existing file.
# 4. Jboss server needs to be restarted after running the script.
# 5. Please ensure to change the '$path' & '$path2' with the installed Jboss server directory path

$ErrorActionPreference="SilentlyContinue"
Stop-Transcript | out-null
$ErrorActionPreference = "Continue"

if(!(Test-path "C:\HTTP_Header"))
{
    New-Item -path "C:\HTTP_Header" -ItemType directory -force
}

Start-Transcript -path "C:\HTTP_Header\HTTP_Header_Log.log" –append 
Write-Output "`n`n"
Write-Output "********************** Transcription started for HTTP_Header_VulnerabilityFix ***********************"


$path = "C:\jboss-5.1.0.GA\jboss-5.1.0.GA\server\all\deployers\jbossweb.deployer"
$file = "web.xml"
$bkpFile = "web_bkp.xml"
$x="$path\$file"

if(!(Test-Path $path\$bkpFile)){
    Write-Host "Working web.xml"
    New-Item $path\$bkpFile -type file
    Copy-Item  $path\$file $path\$bkpFile
    Write-Output "web.xml backup created successfully"
}
$xml=[xml](Get-Content $path\$file)

$wa = "web-app"
$init="init-param"
$name="param-name"
$filter = "filter"

$node = $xml.$wa.$filter.$init.$name.InnerText

$flag = $node -like "X-Powered-By"
if($flag -eq "True"){
$parent = $xml.$wa.$filter.$init

$parent.InnerXml = $parent.InnerXml.Replace($parent.InnerXml, $parent.InnerXml.Insert(0, "<!--").Insert($parent.InnerXml.Length+4, "-->"))
$xml.Save($x)
}



# 2nd part

$path2 = "C:\jboss-5.1.0.GA\jboss-5.1.0.GA\server\all\deploy\jbossweb.sar"
$file2 = "server.xml"
$bkpFile2 = "server_bkp.xml"
$x2="$path2\$file2"

if(!(Test-Path $path2\$bkpFile2)){
    New-Item $path2\$bkpFile2 -type file
    Copy-Item  $path2\$file2 $path2\$bkpFile2
    Write-Output "server.xml backup created successfully"
}



$xml2=[xml](Get-Content $path2\$file2)

$nodeName2 = $xml2."Server"."Service".name
if($nodeName2 -eq "jboss.web"){
    $con2 = $xml2."Server"."Service".Connector
    if($con2[0].protocol -eq "HTTP/1.1"){
       $con2[0].SetAttribute("server","somevalue")
       $con2[0]
    }
    if($con2[1].protocol -eq "AJP/1.3"){
       $con2[1].SetAttribute("server","somevalue")
       $con2[1]
    }
    $xml2.Save($x2)
}

Stop-Transcript